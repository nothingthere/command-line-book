# I/O重定向

本节将学习到的命令：

-   **cat**：合并文件
-   **sort**：排序文本
-   **uniq**：显示/排除重复行
-   **grep**：使用正则匹配行
-   **wc**：统计行数、单词数和byte数
-   **head**：显示文件前面部分
-   **tail**：显示文件后面部分
-   **tee**：从标准输入流读入，写入标准输出流和文件

## 标准输入流、输出流和错误流

目前为止学习到的命令都会有输出内容，其主要有两类：程序执行结果，状态和错误信息。

按Unix“一切皆文件”的说法，以"ls"命令为例，其结果输入到标准输出流（stdout）这一特殊文件，状态和错误信息输入到标准错误流（stderr）另外一个特殊文件。默认情况下，者两个文件只是关联到显示屏，不对向硬盘写入任何数据。

此外，标准输入流（stdin）则默认关联到键盘。

重定向标准流，可使输出不止在显示屏上，输入不止来自键盘。

## 重定向标准输出流

使用重定向操作符“>”可将标准输出流从显示屏重定向到文件。

**将ls命令的输出结果写入ls-output.txt：**

```bash
me@ubuntu16.04:~$ ls -l /usr/bin/ > ls-output.txt
me@ubuntu16.04:~$ less ls-output.txt
.....
```

**用ls命令操作一个不存在的文件夹：**

```bash
me@ubuntu16.04:~$ ls -l /bin/usr > ls-output.txt
ls: cannot access '/bin/usr': No such file or directory
me@ubuntu16.04:~$ ls -l ls-output.txt
-rw-rw-r-- 1 claudio claudio 0 8月  15 15:41 ls-output.txt
```

这里的/bin/usr文件夹并不存在。由于只重定向了标准输出流，没有重定向标准错误流，所以报错信息没有重定向，显示在了显示屏上。由于重定向操作符“>”始终会全部重写文件，且此处没有标准输出，所以“ls-output.txt”内没有内容。

**可利用此特性创建或清空文件：：**

```bash
me@ubuntu16.04:~$ > ls-output.txt
```

使用重定向操作符“>>”可向文件末尾追加内容，不用完全改写。

**向文件追加相同内容：**

```bash
me@ubuntu16.04:~$ ls -l /usr/bin/ >> ls-output.txt
me@ubuntu16.04:~$ ls -l ls-output.txt
-rw-rw-r-- 1 claudio claudio 114386 8月  15 15:51 ls-output.txt
me@ubuntu16.04:~$ ls -l /usr/bin/ >> ls-output.txt
me@ubuntu16.04:~$ ls -l ls-output.txt
-rw-rw-r-- 1 claudio claudio 228772 8月  15 15:51 ls-output.txt
```

## 重定向标准错误流

重定向错误流没有专门的操作符，需使用类型编号。0,1和2分别代表标准输入流输出流和错误流。

**重定向标准错误流：**

```bash
me@ubuntu16.04:~$ ls -l /bin/usr 2> ls-error.txt
```

### 将标准输出流和标准错误流重定向到一个文件

**使用“2>&1”形式将标准输出流和标准错误流重定向到一个文件：**

```bash
me@ubuntu16.04:~$ ls -l /bin/usr > ls-output.txt 2>&1
```

ls-output.txt和2>&1位置不能颠倒。

**可使用“&>”简写代替上述操作：**

```bash
me@ubuntu16.04:~$ ls -l /bin/usr &> ls-output.txt
```

**也可使用简写形式向文件追加内容：**

```bash
me@ubuntu16.04:~$ ls -l /bin/usr &>> ls-output.txt
```

### 隐藏输出内容

**可将不需要的输出内容输出到/dev/null文件中。此特殊文件可接受输入，但毫无变化：**

```bash
me@ubuntu16.04:~$ ls -l /bin/usr 2> /dev/null
```

## 重定向标准输入流

### cat 合并文件

```bash
cat [file...]
```

利用cat命令可将一个或多个文件合并输出。一般用于合并显示多个小文件。

**合并显示文件movie.mpeg.001 movie.mpeg.002 ... movie.mpeg.099：**

```bash
me@ubuntu16.04:~$ cat move.mpeg.0* > movie.mpeg
...
```

**cat命令后不跟任何参数：**

```bash
me@ubuntu16.04:~$ cat
```

此时cat将标准输入流（关联到键盘）中输入到标准输出流（关联到显示屏）中，知道输入EOF（end of file，<kbd>Ctrl+d</kbd>）。

**利用上述特性重定向cat的标准流：**

```bash
me@ubuntu16.04:~$ cat < lazy_dog.txt
The quick brown fox jumped over the lazy dog.
# ^D(Ctrl+d)
# 利用“<”重定向操作符改变标准输入流。
me@ubuntu16.04:~$ cat < lazy_dog.txt
The quick brown fox jumped over the lazy dog.
```

**cat命令的选项：**

| 选项                    | 作用                         |
| :-------------------- | :------------------------- |
| -A --shhow-all        | 等价于-vET                    |
| -b --number-nonblank  | 只为非空行显示行数，可重置-n选项          |
| -e                    | 等价于-vE                     |
| -E --show-ends        | 每行末尾显示“$”                  |
| -n                    | 为每行显示行数                    |
| -s --squeeze-blank    | 将重复空行合并为一行                 |
| -t                    | 等价于-vT                     |
| -t --show-tabs        | 将TAB字符显示为^I                |
| -v --show-nonprinting | 使用^和M-形式显示不可打印字符，LFD和TAB除外 |

## 管道（Pipeline）

使用管道操作符"|"，可将一个命令的标准输出作为另一个命令的标准输入。

**将ls命令的输出内容传递给less命令：**

```bash
me@ubuntu16.04:~$ ls -l /usr/bin | less
...
```

与重定向操作符“>”的区别：

| 操作符 | 形式                       | 作用                  |
| :-- | :----------------------- | :------------------ |
| >   | commadn1 > file1         | 将标准输出流重定向到文件        |
| 竖线  | command1     竖线 command2 | 将标准输出流作为另一个命令的标准输入流 |

### 过滤器

**利用管道，可将多个命令结合在一起，实现过滤作用，最后将结果输出：**

```bash
me@ubuntu16.04:~$ ls /bin /usr/bin | sort | less
...
```

使用ls命令列出/bin和/usr/bin文件夹下的文件，使用sort命令排序，最后使用less命令输出。

### uniq 显示或隐藏重复行

接受排序过的列表（需与sort命令一起使用），去除重复项，或只显示重复项。

**去除重复项：**

```bash
me@ubuntu16.04:~$ ls /bin /usr/bin |sort|uniq|less
...
```

**只显示重复项：**

```bash
me@ubuntu16.04:~$ ls /bin /usr/bin |sort|uniq|less
...
```

uniq命令可接受的选项METHOD={none(default),prepend,separate}：

| 选项                      | 作用                  |
| :---------------------- | :------------------ |
| -c --count              | 在每行前面加上出现次数         |
| -d --repeated           | 只显示重复行，一组一行         |
| -D                      | 显示所有重复行             |
| --all-repeated[=METHOD] | 同-D，不过每组间用空行隔开      |
| -f --skip-fields=N      | 不比较前N个区间？           |
| --group[=METHOD]        | 显示所有项目，每组间用空行隔开i    |
| -i --ignore-case        | 不区分大小写              |
| -s --skip-chars=N       | 不比较前N个字符            |
| -u --unique             | 只显示不同的行             |
| -z --zero-terminated    | 将NUL作为换行，而不是newline |
| -w --check-chars=N      | 只比较前N个字符            |

### wc 统计行数、单词数和byte数

**结果中从前到后分别为行数、单词数、byte数和文件名：**

```bash
me@ubuntu16.04:~$ wc ls-output.txt
  1774  16669 114386 ls-output.txt
```

**仅显示行数：**

```bash
me@ubuntu16.04:~$ ls /bin /usr/bin | sort | uniq | wc -l
...
```

wc命令可接受的选项：

| 选项                   | 作用                                      |
| :------------------- | :-------------------------------------- |
| -l --lines           | 仅显示行数                                   |
| -w --words           | 仅显示单词数                                  |
| -m --chars           | 仅显示字符数                                  |
| -c --bytes           | 仅显示byte数                                |
| -L --max-line-length | 仅显示最大显示宽度？                              |
| --file0-from=F       | 从文件F中读取NUL-terminated名字？。如果F为-，从stdin读取 |

### grep 使用正则匹配行

**使用正则表达式匹配，如果匹配输出所在行：**

```bash
grep pattern [file...]
```

**显示含“zip”的行：**

```bash
me@ubuntu16.04:~$ ls /bin /usr/bin | sort | uniq | grep zip
...
```

grep接受的匹配选项：

| 选项                | 作用      |
| :---------------- | :------ |
| -i --ignore-case  | 不区分大小写  |
| -v --invert-match | 显示不匹配的行 |
| ...               |         |

### head/tail 显示文件前/后部分

显示结果的的前/后行，默认为10行，可使用“-n”选项指定显示行数：

**显示前/后5行：**

```bash
me@ubuntu16.04:~$ head -n 5 ls-output.txt
...
me@ubuntu16.04:~$ tail -n 5 ls-output.txt
```

head接受的选项：

| 选项                   | 作用                |
| :------------------- | :---------------- |
| -c --bytes=[-]NUM    | 显示前多少byte数，支持负数   |
| -n --lines=[-]NUM    | 显示前多少行数，支持负数      |
| -q --slient, --quiet | 不显示文件名（默认）        |
| -v --verbose         | 显示文件名             |
| -z --zero-terminated | 行以NUL结尾，非newline？ |

tail接受的选项，除同head接受的选项一样外，还有：

-   \-f --follow=[{name|descriptor（default）}]：监听文件更新。
-   \-F：同--follow=name --retry相同
-   \--max-unchanged-stats=N：与--follow=name一起使用，如果文件N（默认为5）秒后大小没有改变，将其重新打开。
-   \--pid=PID：与-f一起使用，当进程PID退出后终止。
-   \-s --sleep-interval=N：与-f一起使用，轮询间隔为N（默认为1.0）秒；与--pid=P一起使用时，至少间隔N秒检测P是否退出。
-   \--retry：如果文件打开失败，一直尝试。

**利用tail的监听功能监听日志文件。<kbd>Ctrl+c</kbd>退出：**

```bash
me@ubuntu16.04:~$ tail -f /var/log/syslog
...
```

### tee 从标准输入流读入，写入标准输出流和文件

**使用tee命令可将输入内容写入文件同时，继续在管道中传递：**

```bash
me@ubuntu16.04:~$ ls /usr/bin | tee ls.txt | grep zip
...
```

将ls命令的结果输出到“ls.txt”文件，再在管道中传给grep命令。
