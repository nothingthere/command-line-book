# 进程

本节将学习到的命令：

-   **ps**：报告当前所有进程概况
-   **top**：显示所有任务
-   **jobs**：列出活动jobs
-   **bg**：将一个job置于后台
-   **fg**：将一个job置于前台
-   **kill**：向单个进程发送信号（signal）
-   **killall**：通过名字杀死进程
-   **shutdown**：关闭或重启系统

## 进程如何工作

系统启动时，内核将多个自身活动作为进程初始化，并启动名为init.init的程序。init.init程序反过来运行一系列位于/etc目录下的shell脚本，利用这些脚本启动所有系统服务。这些服务中许多为后台程序（daemon programs），不提供用户界面。所以，即使系统启动后，没有登陆前，系统也在运行许多日常服务。

利用父进程（parent process）和子进程（child process）的机制，一个程序可启动其它多个程序。

为使整个系统更有调理，内核负责维护每个进程的信息。比如，每个进程都被赋值一个进程ID（process ID，PID）。赋值PID采用递增模式，其中init进程的PID始终为1。内核同时还跟踪分配给每个进程的内存，以及进程执行状态？。同文件，进程也有所有者和用户ID、有效用户ID等。

## 查看进程

查看进程最常用的命令为ps，其选项较多，下面介绍几种常用选项。

**不带任何参数，显示当前shell实例中打开的进程：**

```bash
# 只用当前shell实例运行了ps一个进程
me@ubuntu16.04:~$ ps
  PID TTY          TIME CMD
 5801 pts/20   00:00:00 bash
 6033 pts/20   00:00:00 ps
```

**使用x选项查看当前用户所有的所有进程：**

```bash
me@ubuntu16.04:~$ ps x
  PID TTY      STAT   TIME COMMAND
 3021 ?        Ss     0:00 /lib/systemd/systemd --user
 3022 ?        S      0:00 (sd-pam)
 3028 ?        SLl    0:00 /usr/bin/gnome-keyring-daemon --daemonize --login
 3030 ?        Ss     0:00 /sbin/upstart --user
...
```

-   TTY：teletype，控制此进程的shell实例。“?”表示此进程不属于任何shell实例。
-   TIME：CPU处理此进程所耗时间。
-   STAT：“state”的缩写，表示该进程的状态。

STAT中各字符含义：

-   R：Running。表示此进程正在/准备运行。
-   S：Sleeping。此进程暂时没有运行，在等待触发事件，如键盘输入等。
-   D：Uninterruptible Sleep。正在等待I/O，如硬盘驱动。
-   T：Stopped。已被发送指令停止。
-   Z：死掉/“僵尸”（zombie）程序。此进程为已停止运行的子进程，但并没有被其父进程清除。
-   &lt;：高优先权进程。可为进程授权更高的权重，提供更多的CPU计算时间。此属性称为“谦让性（niceness）”。如果进程优先权越高，其“谦让性”就越低。因为其占用的更多的CPU计算时间，留给其它进程的时间就更少。
-   N：低优先权进程。其它进程服务启动后，才开始占用CPU计算。

**使用aux选项查看更详细的进程信息：**

```bash
me@ubuntu16.04:~$ ps aux
USER       PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND
root         1  0.0  0.1 119936  6148 ?        Ss   05:56   0:01 /sbin/init spla
root         2  0.0  0.0      0     0 ?        S    05:56   0:00 [kthreadd]
root         3  0.0  0.0   
...
```

其中各行的含义为：

| 名称    | 含义                      |
| :---- | :---------------------- |
| USER  | 用户ID。该进程的拥有者            |
| %CPU  | CPU使用百分比                |
| %MEN  | 内存使用百分比                 |
| VSZ   | 所占虚拟内存大小                |
| RSS   | 物理内存（RAM）使用量（单位kb）      |
| START | 进程开启时间。如果超出24小时，以"天"为单位 |

### top 动态查看进程

使用top命令，动态查看进程。显示结果实时更新，默认为3秒更新一次；由2部分组成：系统概况和按照CPU使用量排序的所有进程。

**top命令显示结果：**

```bash
top - 15:39:46 up 11 min,  1 user,  load average: 0.37, 0.43, 0.37
Tasks: 222 total,   1 running, 221 sleeping,   0 stopped,   0 zombie
%Cpu(s):  1.1 us,  0.8 sy,  0.0 ni, 97.6 id,  0.4 wa,  0.0 hi,  0.0 si,  0.0 st
KiB Mem :  3862360 total,  1492884 free,  1192368 used,  1177108 buff/cache
KiB Swap:  3998716 total,  3998716 free,        0 used.  2222048 avail Mem

  PID USER      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND     
 3273 me    9 -11  507744  11260   8268 S   3.3  0.3   0:03.88 pulseaudio  
 4072 me   20   0 1602364 122680  70756 S   1.7  3.2   0:07.52 atom        
 2600 root      20   0  425056  78484  52348 S   0.8  2.0   0:14.23 Xorg        
 3179 me   20   0 1257780 111368  63068 S   0.8  2.9   0:12.56 compiz
....
```

下面介绍系统概况部分每行的含义：

-   第一行：top，本程序名称；15:39:46，当前时间；up 11 min，开机到现在的时长；1 user，登陆用户为1个；load average，等待运行的程序，即处于可执行状态且共享CPU的进程，3个数字分别代表计算时所取时长，分别为60秒、5分钟和15分钟，只要小于1.0都表示系统不繁忙。

-   第二行：tasks，所有进程数量和状态概况。
-   第三行：Cpu(s)，CPU使用概况。1.1 us，1.1%的CPU用于用户进程，即除内核外的所有进程； 0.8 sy，0.8%的CPU用于内核进程； 0.0 ni，0.0%的进程用于“谦让性”(nice)进程，即执行优先权低的进程；97.6 id，97.6%的CPU处于闲置状态； 0.4 wa，0.4%的CPU正在等待I/O响应。

-   第四行：Mem，物理内存使用状况。
-   第五行：Swap，交换分区（虚拟内存）使用状况。

## 控制进程

**执行xlogo服务用作学习测试。启动成功后，出现一个可缩放图像窗口：**

```bash
me@ubuntu16.04:~$ xlogo
```

### 取消进程

**使用快捷键<kbd>Ctrl-c</kbd>可取消当前进程。：**

```bash
me@ubuntu16.04:~$ xlogo
# Ctrl-c
# ^C
me@ubuntu16.04:~$
```

许多（不是全部）命令行程序都可用<kbd>Ctrl-c</kbd>终止。

### 将进程放置到后台

如需运行一个程序，但又希望继续使用当前shell实例，可将此程序置于后台。

**执行程序，并立即将其置于后台，在后添加“&”符号：**

```bash
me@ubuntu16.04:~$ xlogo &
[1] 4980
me@ubuntu16.04:~$
```

返回值`[1] 4980`为job控制信息，其中数字1（“[1]”）表示job数字，“4980”表示PID。

**执行ps命令，可看到置于后台的进程：**

```bash
me@ubuntu16.04:~$ ps
PID TTY          TIME CMD
4979 pts/12   00:00:00 bash
4980 pts/12   00:00:00 xlogo
4981 pts/12   00:00:00 ps
```

**可使用job命令列出当前shell实例打开的jobs：**

```bash
me@ubuntu16.04:~$ jobs
[1]+ Running      xlogo &
```

上面返回的含义为，只有一个job，编号为“1”，正在运行，且启动命令为`xlogo &`。

### 将进程拉回到前台

**命令行无法直接控制后台运行的程序，需使用fg命令将其拉回前台：**

```bash
me@ubuntu16.04:~$ jobs
[1]+ Running      xlogo &
me@ubuntu16.04:~$ fg %1
```

其中“%1”为job膨胀，“1”为需要置于前台的job编号（jobspec）。

使用fg和bg命令时，如果jobs只有1个，可省略job编号膨胀（%1）。

### 暂停进程

后台运行程序与暂停程序的区别在于，前者正常运行，后者不运行，但没有关闭。

**暂停前台进程的方法为使用<kbd>Ctrl-z</kbd>快捷键：**

```bash
me@ubuntu16.04:~$ xlogo
# Ctrl-z
[1]+ Stopped      xlogo
me@ubuntu16.04:~$
```

此时如果缩放xlogo程序图形界面，“X”图标不会跟随缩放，证明此程序已被暂停。

**重新运行暂停进程的方法为，使用fg或bg命令将其“拉回”：：**

```bash
me@ubuntu16.04:~$ bg %1
[1]+ xlogo &
me@ubuntu16.04:~$
```

## 信号

**使用kill命令可“杀死”进程：**

```bash
me@ubuntu16.04:~$ xlogo & # 启动xlogo程序，并置于后台
[1] 6274 # 输出job编号和PID
me@ubuntu16.04:~$ kill 6274 # 利用PID终止进程（也可使用job编号膨胀）
me@ubuntu16.04:~$
```

kill命令并不是真正“杀死”进程，而是向进程发送了信号（signal）。信号是操作系统与程序交流的方式之一。比如上面使用的快捷键<kbd>Ctrl-c</kbd>和<kbd>Ctrl-z</kbd>，当命令行接受这两个快捷键是，实际上是分别向前台程序发送了INT（Interrupt）和TSTP（Terminal Stop）信号。程序方面，一直都在“监听”信号，并对应用在自身的信号做出反应。

### kill 向进程发送信号

基本用法：`kill [-signal] PID...`。如果不提供选项，默认发送TERM（Terminate）信号。常用信号有（括号内为等价数字代码）：

-   HUP（1）。Hangup，向程序支出控制命令行已经“挂起”。与关闭控制该程序的命令行效果一样？。该命令行内的前台程序接受此信号后，停止运行；对后台程序而言，实现重新初始化的效果。即，当后台程序接受此信号后，重启并重新读取其配置文件，Apache服务器就是使用如此使用HUP信号？。

-   INIT（2）。Interrupt，与使用<kbd>Ctrl-c</kbd>效果相同，通常会总之程序。
-   KILL（9）。,Kill，是个特殊信号。由于不同程序处理信号的方式不同，如完全忽视，此信号实际上并不直接发送给目标程序，而是通过内核立即终止进程。用此方式终止的进程，无法“clean up”和保存内容？。因此KILL信号应当在所有终止信号尝试失败时才使用。
-   TERM（15）。Terminate，**kill命令使用的默认信号**。如果某个程序依然“活跃（alive）”，将被终止。
-   CONT（18）。Continue，恢复接收STOP信号后的进程。与使用<kbd>Ctrl-z</kbd>快捷键，在将其置于后台效果相同。
-   STOP（19）。Stop，使进程暂停，效果如<kbd>Ctrl-z</kbd>快捷键。同KILL信号一样，并不直接发送给目标进程，所以无法忽略。

**例：**

```bash
me@ubuntu16.04:~$ xlogo & # 将程序置于后台
[1] 123456
me@ubuntu16.04:~$ kill -1 123456 # 发送HUP信号
claudio@claudio:~$ # 按回车
[1]+  Hangup                  xlogo # 显示接收信号后的信息
```

**可使用数字、名称和带“SIG”前缀的名称发送信号。下面3种方式等价：**

```bash
me@ubuntu16.04:~$ xlogo &
[1] 123456
me@ubuntu16.04:~$ kill -1 123456 # 使用数字
me@ubuntu16.04:~$ xlogo &
[1] 123456
me@ubuntu16.04:~$ kill -HUP 123456 # 使用名称
me@ubuntu16.04:~$ xlogo &
[1] 123456
me@ubuntu16.04:~$ kill -SIGHUP 123456 # 使用带前缀的名称
```

下面列出一些系统常用的信号及其含义：

-   QUIT（3）。Quit，放弃。
-   SEGV（11）。Segmentation Voilation，如果某程序非法使用内存，即尝试在不允许的文件写入数据时发送此信号。
-   TSTP（20）。Terminal Stop。当<kbd>Ctrl-z</kbd>按下时命令行发出的信号。不想STOP信号，程序接收到TSTP信号后，可选择忽略。
-   WINCH（28）。Window Change，当程序所在窗口缩放时，系统发出的信号。如top和less程序，接受到此信号后更改行为，以使用当前窗口大小。

**查看所有kill可接受的选项使用“-l”选项：**

```bash
me@ubuntu16.04:~$ kill -l
...
```

### killall 向多个进程同时发送信号

使用killall命令可以同时向多个进程（可指定所属用户或某类），基本用法为`killall [-u user] [-signal] name...`。

**运行多个xlogo实例后，使用killall命令通知发送终止信号：**

```bash
me@ubuntu16.04:~$ xlogo &
[1] 7788
me@ubuntu16.04:~$ xlogo &
[2] 7789
me@ubuntu16.04:~$ killall xlogo
me@ubuntu16.04:~$ # 再次按下回车键才能显示结果
[1]-  Terminated              xlogo
[2]+  Terminated              xlogo
```

与kill命令相同，向所有权不为当前用户的进程发送信号，需要超级权限。

## 关闭系统

有4个命令可关闭系统：`halt`、`poweroff`、`reboot`和`shutdown`，其中前3个为按其名称就可知道其功能，且安装它们的手册描述，都仅为向后兼容保留的命令，不如`shutdown`应用灵活（可实现halt、poweroff、reboot和shutdown功能，还可指定时间）。

**使用reboot命令重启：**

```bash
me@ubuntu16.04:~$ sudo reboot
```

**等价的shutdown命令：**

```bash
me@ubuntu16.04:~$ sudo shutdown -r now
```

**使用shutdown命令关机：**

```bash
me@ubuntu16.04:~$ sudo shutdown now
```

第一个参数为时间，通常为“now”，其它方式参考手册；紧随其后为提醒信息，用于通知所有登陆用户关机信息。

## 其它常用进程命令

检测进程是系统管理的重要任务，有许多相关命令，下面介绍4个：

-   pstree：以树状形式列出进程，突出父进程和子进程关系。
-   vmstat：显示系统资源使用概况，包括内存、交换分区和硬盘I/O（disk I/O）。如需实时更新，可在后面跟上间隔描述，如`vmstat 5`，结束使用<kbd>Ctrl-c</kbd>命令。
-   xload：使用图像界面实时绘制系统负载
-   tload：与xload功能相同，不过是在命令行绘制。
