# 权限

Unix允许多用户同时使用，且独立受保护。

本小节将学习到的命令：

-   **id**：显示用户身份信息
-   **chmod**：更改文件模式（权限）
-   **unmask**：设置文件默认权限
-   **su**：更换用户运行shell
-   **sudo**：更换用户执行命令
-   **chonw**：更改文件所有权
-   **chgrp**：更改文件用户组所有权
-   **passwd**：更改用户密码

## 用户权限、用户组权限和全局权限

**尝试读取/etc/shadow文件。读取失败。原因为普通用户没有权限读取此文件：**

```bash
me@ubuntu16.04:~$ file /etc/shadow
/etc/shadow: regular file, no read permission
me@ubuntu16.04:~$ less /etc/shadow
/etc/shadow: Permission denied
```

文件所有权限有3种形式：

1.  _用户_：如果文件/文件夹权限属于某用户，该用户可控制其访问权限。
2.  _用户组_：如果文件/文件夹属于用户组，用户组成员可访问。
3.  _全局_：如果文件/文件夹权限属于全局，所有用户可访问。

**使用id命令显示身份信息：**

```bash
me@ubuntu16.04:~$ id
uid=500(me) gid=500(me) groups=500(me)
```

当用户账号创建后，被赋予一个ID/uid，和一个主要用户组ID/gid，并可能属于某个用户组。

**以上是Fedora系统的信息，其它系统，如Ubuntu稍有不同。Ubuntu用户可属于多个用户组：**

```bash
me@ubuntu16.04:~$ id
uid=1000(me) gid=1000(me)
groups=4(adm),20(dialout),24(cdrom),25(floppy),29(audio),30(dip),44(v
ideo),46(plugdev),108(lpadmin),114(admin),1000(me)
```

以上信息中，用户账号存储在/etc/passwd文件中，用户组信息存储在/etc/group文件中。当用户账号创建后，以上2个文件随/etc/shadow文件（存储用户密码）更改。对各用户账号而言，/etc/passwd文件定义了该用户的登录名、uid、gid、账号真实名、home文件夹以及登陆shell。在/etc/passwd和/etc/group文件中，都定义了一个uid为0的的用户，便是超级用户。

## 读、写和执行权限

文件权限由3种：只读权限、写入权限和执行权限。

**使用ls命令查看文件权限：**

```bash
me@ubuntu16.04:~$ > foo.txt
me@ubuntu16.04:~$ ls -l foo.txt
-rw-rw-r-- 1 me me 0 8月  18 15:03 foo.txt
```

返回结果中，第一区域中的10个字符表示_文件属性_。其中第一个字母表示_文件类型_，以下为常见的文件类型：

| 属性  | 文件类型                                                          |
| :-- | :------------------------------------------------------------ |
| -   | 普通文件                                                          |
| d   | 文件夹                                                           |
| l   | 软链接。剩余的9个属性字符都为“rwxrwxrwx”，真实文件属性同其指向文件                       |
| c   | _字符特殊文件（character special file）_。指向处理byte流数据的设备，如命令行和猫（modem） |
| b   | _块特殊文件（block special file）_。指向处理块数据的设备如硬盘和CD-ROM              |

剩余的9个字符3个一组，分别代表用户权限、用户组权限和全局权限。

“rwx”3个字符分别代表的含义：

-   **r（只读）**：对文件而言，允许打开和读取；对文件夹而言，如果有执行属性，允许列出文件夹中的内容。
-   **w（写入）**：允许文件被写入和清空，但不允许被重命名和删除，重命名和删除权限取决于所在文件夹的权限；对文件夹而言，允许在文件夹中创建和删除文件，如果有执行属性，允许重命名其中的文件。

-   **x（执行）**：允许文件被视作程序，并被执行。使用脚本语言编写的文件需设置只读和执行权限；对文件夹而言，允许进入文件夹，如执行“cd directory”命令。

**权限属性举例：**

-   \-rwx------：普通文件，拥有用户可读、写和执行该文件。其它用户没有任何权限。
-   \-rw-------：普通文件，拥有用户可读和写。其它用户没有任何权限。
-   \-rw-r--r--：普通文件，拥有用户可读和写，拥有用户组可读，所有用户可读。
-   \-rwx-rx-x：普通文件，拥有用户可读、写和执行，拥有用户组可读和执行，其它所有用户可执行。
-   \-rw-rw----：普通文件，文件拥有者和拥有用户组可读和写，其它用户没有任何权限。
-   lrwxrwxrwx：软链接，后面的9个属性字符无含义，其权限取决于指向的文件权限。
-   drwxrwx---：文件夹，文件拥有者和用户组可进入文件夹，在内创建、重命名和移动文件。
-   drwxr-x---：文件夹，拥有用户可进入文件夹，在内创建、重命名和移动文件夹；拥有用户组可进入文件夹，但不可在内创建、重命名和移动文件夹。

### chmod 更改文件模式（权限）

只有拥有用户和超级用户才有权限使用chmod命令修改文件模式。有使用八进制数和字符2中方式改变文件模式。

#### 使用八进制数

**八进制数、二进制数和文件模式对比表：**

| 把仅指数 | 二进制数 | 文件模式 |
| :--- | :--- | :--- |
| 0    | 000  | ---  |
| 1    | 001  | --x  |
| 2    | 010  | -w-  |
| 3    | 011  | -wx  |
| 4    | 100  | r--  |
| 5    | 101  | r-x  |
| 6    | 110  | rw-  |
| 7    | 111  | rwx  |

_其中常用的有7（rwx）、6（rw-）、5（r-x）、4（r--）和0（---）者几种模式。_

**例：**

```bash
me@ubuntu16.04:~$ > foo.txt
me@ubuntu16.04:~$ ls -l foo.txt
-rw-rw-r-- 1 me me 0 8月  18 16:03 foo.txt
me@ubuntu16.04:~$ chmod 600 foo.txt #将权限更改为，只有拥有用户可读写
me@ubuntu16.04:~$ ls -l foo.txt
-rw------- 1 me me 0 8月  18 16:03 foo.txt
```

#### 使用符号

使用符号修改文件模式时，其中的符号由3部分组成：目标用户、操作（添加/删除）和权限。

目标用户由一下字符表示：

| 字符  | 含义                        |
| :-- | :------------------------ |
| u   | “user”的缩写，表示文件拥有用户        |
| g   | 拥有用户组                     |
| o   | “others”的缩写，除拥有用户和用户组的用户？ |
| a   | “all”的缩写，即“u”、“g”和“o”的结合  |

_如果没有表示目标用户的字符，默认为“all”，即所有用户。_

表示操作的符号有：

| 字符  | 含义                  |
| :-- | :------------------ |
| +   | 添加权限                |
| -   | 删除权限                |
| =   | 删除所有已有权限，仅使用此处设置的权限 |

例：

-   _u+x_：为拥有用户添加执行权限。
-   _u-x_：删除拥有用户的执行权限。
-   _+x_：为拥有用户、用户组和全局用户添加执行权限，等价于“a+x”。
-   _o-rw_：删除除拥有用户和用户组外，用户的读和写权限。
-   _go=rw_：将拥有用户组和全局用户的权限设置为读和写。如果拥有用户和其它用户有执行权限，删除。

#### 常用4位八进制权限

实际上，使用4位八进制数表示权限更准确，因为除读、写和执行权限外，还有一些不常用的权限，下面介绍3种：

-   4000（setuid bit），对应符号`chmod u+s program`，设置结果`-rwsr-xr-x`。当为执行文件设置此权限时，将其“有效用户ID（effective user ID）”从真实用户（运行该程序的用户）更改为该程序的拥有者。此设置绝大多数应用在超级用户所有的程序文件上。当普通用户执行运行此类文件时，该程序个使用普通情况下普通用户无权限的文件和文件夹。
-   2000（setgid bit），对应符号`chmod g+s dir`，设置结果`drwxrwsr-x`。将文件“有效用户组ID（effective group ID）”从真实用户组（运行该程序的用户）更改为该文件的拥有者。如果为文件夹设置此权限，其中下创建的新文件的用户组权限为该文件夹的用户组权限，而非文件创建者的用户组权限。在创建共享文件夹时，如需该用户组内的所有成员对其中的文件都有控制权，就需设置此权限。
-   1000（sticky bit），对应符号`chmod +t dir`，设置结果`drwxrwxrwt`。对文件设置此权限时，Unix忽略；对文件夹设置此权限时，除文件夹拥有者、文件拥有者和超级用户外，不可删除或重命名其中的文件。通常应用在共享文件夹上，如/tmp。

### unmask 设置文件默认权限

**不跟任何参数，查看mask值：**

```bash
me@ubuntu16.04:~$ umask
002
```

_有的系统默认值为022。_

**更改mask值，并查看文件权限：**

```bash
claudio@claudio:~$ umask #查看umask值
0002
claudio@claudio:~$ > foo.txt #新建文件
claudio@claudio:~$ ls -l foo.txt #查看其mask值
-rw-rw-r-- 1 claudio claudio 0 8月  20 13:33 foo.txt
claudio@claudio:~$ umask 000 #重置mask值
claudio@claudio:~$ rm foo.txt #删除该文件并新建
claudio@claudio:~$ > foo.txt
claudio@claudio:~$ ls -l foo.txt #查看新建文件权限
-rw-rw-rw- 1 claudio claudio 0 8月  20 13:34 foo.txt
```

umask命令后的参数值范围为000-777。

计算方法，观察下面2例：

| 原本权限       | --- rw- rw- rw-  |
| :--------- | :--------------- |
| mask值（2进制） | 000 000 000 010  |
| mask值（8进制） | 002              |
| 结果         | --- rw- rw- r--- |

| 原本权限       | --- rw- rw- rw-  |
| :--------- | :--------------- |
| mask值（2进制） | 000 000 010 010  |
| mask值（8进制） | 022              |
| 结果         | --- rw- r-- r--- |

可见，如果二进制数位置上为1，其对应位置的权限就被删除。

## 添加用户和用户组

<http://blog.csdn.net/lele52141/article/details/6593840>

### adduser/useradd

执行命令“adduser”根据提示设置密码和其它选项即可。

"useradd"和“adduser”命令的区别在于，后者是前者的简单化版本，通过提示完成操作；前者每个参数需手动配置。

### userdel

“userdel”命令可删除用户。下面为其选项：

-   \-f -force：强制删除用户账号，即使是当前登陆账号也可。同时强制删除该用户的的home文件夹和mail spool，即使另一个用户也使用该home文件夹，或者该mail spool不属于特定用户。

-   \-r --remove：删除该用户的home文件夹和mail spool，但文件系统中的相关文件需手动删除。

### addgroup？

/etc/group文件里有所有组信息。以下命令可以创建新组：

```bash
groupadd -g "gid" "group name"
```

其中"-g"选项代表groupid。需查看/etc/group文件，保证不重复，且大于起始值，如1000。

**删除用户组：**

```bash
delgroup "group name"
```

将已有用户添加到已有用户组，使用**usermod**
命令：

```bash
usermod -a -G "group name" "user name"
```

## 更换用户

更换用户有3种方法：

1.  在图形界面更换用户
2.  使用su命令
3.  使用sudo命令

其中后面两种可在当前shell实例（shell session，即打开的shell窗口）中操作，更方便。su命令更改当前用户，进入新的shell实例，或者使用新用户账号执行单个命令。

使用sudo命令，可使管理员配置/etc/sudoers文件，指定某用户可执行的命令。

sudo还是su命令的用法在不同版本（如ubuntu）中用法差异较大，有的版本两个命令都有。

### su 以新用户和用户组运行shell

**基本用法：**

```bash
su [-\[l\]] [user]
```

如果指定了-l选项，再指定user选项，登陆后，工作文件夹将成为新用户的home文件夹；如果不指定新用户名，默认使用超级用户，且“-l”可缩写为“-”，进入超级用户账号后，命令行中的“$”字符将变为“#”：

```bash
me@ubuntu16.04:~$ su -l
root@ubuntu16.04:~#
```

> 在ubuntu中，sudo命令拥有su命令的权限，如需使用su命令，需结合sudo一起使用，上例在ubuntu中应为:

```bash
me@ubuntu16.04:~$ sudo su -l
root@ubuntu16.04:~#
```

**使用exit命令退出超级用户（此命令可用于多用户间切换）：**

```bash
root@ubuntu16.04:~# exit
logout
me@ubuntu16.04:~$
```

进入新用户shell实例后，使用命令sudo时，会报错"\[用户名] is not in the sudoers file"。解决办法参考： <http://askubuntu.com/questions/151200/my-main-username-is-not-in-the-sudoers-file>。

即修改/etc/sudoers文件。编辑此文件后，如果写入内容有语法错误，会导致sudo命令不能正常运行，解决方法为 [执行`pkexec visudo`命令](http://askubuntu.com/questions/73864/how-to-modify-a-invalid-etc-sudoers-file-it-throws-out-an-error-and-not-allowi)。

**也可使用su命令执行单个命令，不退出当前用户：**

```bash
me@ubuntu16.04:~$ sudo su -c 'ls -l /home/'
total 24
drwxr-xr-x 32 me       me   4096 8月  20 18:40 me
drwxr-xr-x 19 fsociety fsociety  4096 8月  20 18:43 fsociety
drwx------  2 root     root     16384 8月  10 14:55 lost+found
me@ubuntu16.04:~$ #依然在当前用户的shell实例下
```

其中“-c”选项表示执行命令，命令内容需包含在单引号内，防止在当前shell实例中膨胀。

### sudo 以新用户运行单个命令

sudo与su的区别有以下几点：

-   管理员可配置sudo命令，使普通用户如超级用户一样执行命令
-   使用sudo命令是，不需使用超级用户密码，而是当前用户密码
-   sudo并不进入新的shell实例，也不加载所需用户环境，_需执行的命令也不需包裹在单引号中_

**查看sudo可执行的命令：**

```bash
me@ubuntu16.04:~$ sudo -l
[sudo] password for me:
Matching Defaults entries for me on ubuntu16.04:
    env_reset, mail_badpass,
    secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin

User me may run the following commands on cubuntu16.04:
    (ALL : ALL) ALL
```

### chown 更改文件所有用户和所有用户组

用法为：

```bash
"chonw [owner][:[group]] file..."
```

更改所有用户和/或取决于第一个参数，参考下面例子：

-   `chown bob file`：将文件所有权从当前用户转交到bob
-   `chown bob:users file`：将文件所有权从当前用户转交到bob，并将文件所有权用户组改为users
-   `chown :admins fils`： 将文件所有权用户组改为admins，用户所有权不变
-   `chown bob:`：将文件所有权从当前用户转交到bob，并将所有权用户组更改为用户bob的登陆用户组

观察下例，假设有超级用户权限的用户janet，和没有超级用户权限的用户tony。janet将home文件夹下的文件复制到tony的home文件夹下，如需使tony对复制的文件有写入权限，就要将复制文件的所有权转交到tony:

```bash
janet@ubuntu16.04:~$ sudo cp foo.txt ~tony/
[sudo] password for janet:
janet@ubuntu16.04:~$ sudo ls -l ~tony/foo.txt
# 由于使用了sudo命令，此时权限为root
-rw-r--r-- 1 root root 0 8月  20 19:59 /home/tony/foo.txt
# 将复制文件所有权转交到tony
# 后面加冒号后，用户组所有权也改变为tony登陆的用户组（此处为tony）
janet@ubuntu16.04:~$ sudo chown tony: ~tony/foo.txt
janet@ubuntu16.04:~$ sudo ls -l ~tony/foo.txt
-rw-r--r-- 1 tony tony 0 8月  20 19:59 /home/tony/foo.txt
```

### chgrp 更改文件所有用户组

Unix老旧版本中，chown命令仅可更改文件所有权用户，不能更改所有权用户组，更改后者需使用命令chgrp。

## 修改密码

使用命令passwd修改密码。用法`passwd [user]`，如果不指定user，则修改当前用户密码。

## 实践

假设有用户bill（可通过sudo使用超级权限）和karen，希望创建一个共享文件夹存储mp3文件。

**bill创建用户组music，并将bill和karen拉进该用户组：**

```bash
bill@ubuntu16.04:~$ sudo groupadd -g 1002 music
bill@ubuntu16.04:~$ sudo usermod -a -G music bill
bill@ubuntu16.04:~$ sudo usermod -a -G music karen
```

**bill创建共享文件夹Music，并查看其权限，由于不是在bill的home目录下创建，需超级权限：**

```bash
bill@ubuntu16.04:~$ sudo mkdir /usr/local/share/Muisc
bill@ubuntu16.04:~$ ls -ld /usr/local/share/Music
drwxr-xr-x 2 root music 4096 8月  21 16:47 /usr/local/share/Music
```

**为使此文件夹可共享，修改其所有用户组和用户组权限：**

```bash
bill@ubuntu16.04:~$ sudo chown :music /usr/local/share/Music/
bill@ubuntu16.04:~$ ls -ld /usr/local/share/Music/
drwxr-xr-x 2 root music 4096 8月  22 06:05 /usr/local/share/Music/
bill@ubuntu16.04:~$ sudo chmod 775 /usr/local/share/Music/
bill@ubuntu16.04:~$ ls -ld /usr/local/share/Music/
drwxrwxr-x 2 root music 4096 8月  22 06:05 /usr/local/share/Music/
```

所有权用户为root，所有用户组为music。bill和karen为music用户组成员，所以两者可在其中新建文件夹；其它用户可列出其中内容，但不可在内创建文件。

**但在其中创建的文件和文件夹其用户和用户组权限都为创建用户：**

```bash
bill@ubuntu16.04:~$ > /usr/local/share/Music/test_file
bill@ubuntu16.04:~$ ls -l /usr/local/share/Music/test_file
-rw-rw-r-- 1 bill bill 0 8月  22 06:10 /usr/local/share/Music/test_file
bill@ubuntu16.04:~$ mkdir /usr/local/share/Music/test_dir
bill@ubuntu16.04:~$ ls -ld /usr/local/share/Music/test_dir/
drwxrwxr-x 2 bill bill 4096 8月  22 06:11 /usr/local/share/Music/test_dir/
```

**修改方式为使用上文简绍的setgid方式修改文件夹权限：**

```bash
bill@ubuntu16.04:~$ sudo chmod g+s /usr/local/share/Music/
bill@ubuntu16.04:~$ ls -ld /usr/local/share/Music/
drwxrwsr-x 4 root music 4096 8月  22 06:17 /usr/local/share/Music/
```

**权限修改后，新建文件和文件夹所有组权限就会是music：**

```bash
bill@ubuntu16.04:~$ > /usr/local/share/Music/test_file2
bill@ubuntu16.04:~$ ls -l /usr/local/share/Music/test_file2
-rw-rw-r-- 1 claudio music 0 8月  22 06:16 /usr/local/share/Music/test_file2
bill@ubuntu16.04:~$ mkdir /usr/local/share/Music/test_dir2
bill@ubuntu16.04:~$ ls -ld /usr/local/share/Music/test_dir2
drwxrwsr-x 2 me music 4096 8月  22 06:17 /usr/local/share/Music/test_dir2
```
