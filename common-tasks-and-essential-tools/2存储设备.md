# 存储设备

以往章节都是以文件为单位讨论数据处理，本节以设备为单位讨论数据处理。不管是物理存储设备，如硬盘和网络连接存储（nerwork storage）；还是虚拟存储设备，如磁盘阵列（Redundant Arrays of Independent Disks，RAID）和逻辑卷管理（Logical Volume Manager，LVM），Linux都有出色的处理能力。

学习本节需要的设备有可擦写光盘（CD-RW）、U盘（usb flash drive）和<del>软盘（floppy disk）</del>。

本节将学习到的命令有：

-   **mount**：挂载文件系统。
-   **umount**：对文件系统解除挂载
-   **fsck**：检测和修复文件系统
-   **fdisk**：磁盘分区表操作（Partition table manipulator）
-   **mkfs**：创建文件系统
-   **fdformat**：格式化软盘
-   **genisoimage（mkisofs）**：创建一个ISO镜像文件
-   **wodim（cdrecord）**：将数据写入存储介质（optical storage media）
-   **md5sum**：计算MD5值

## 挂载和取消挂载存储设备

操作存储设备，首先需将其添加到文件系统树上，成为操作系统的一部分。此过程即称为_挂载_。

在桌面系统上，存储设备会自带挂载。以Ubuntu16.04为例，U盘和光盘会自带挂载到“/media/用户名”目录下，安卓手机会挂载到“/run/user/用户名ID（一般为1000）/gvfs”目录下。_在服务器上，则需手动挂载。_

/etc/fstab（“file system tabe”的缩写）文件中包含所有系统启动时就挂载的设备（一般为硬盘分区）：

```text
# <file system> <mount point>   <type>  <options>       <dump>  <pass>
# / was on /dev/sda1 during installation
UUID=2b59c6b3-ced1-4535-a730-095092943a66 /               ext4    errors=remount-ro 0       1
# /home was on /dev/sda6 during installation
UUID=796f3a21-35bd-48c8-9b53-bb6214a0a50b /home           ext4    defaults        0       2
# swap was on /dev/sda5 during installation
UUID=34cc34a6-139d-45da-aea8-94924140285e none            swap    sw              0       0
```

各列的含义分别为：

1.  设备名（文件系统，file system）。传统情况下为系统中物理设备的真实名字，如dev/sda1（第一个硬盘上的第一个分区）。不过现今一般使用标签（label）表示，标签可以是纯文本或UUID（如上）。当设备连接系统时，系统读取此标签。
2.  挂载点（mount point）。设备在系统文件树上对应的位置。
3.  文件类型（type）。绝大多数Linux系统使用ext4（第四代扩展文件系统，Fourth Extended
    File System），不过也支持FAT16 (msdos)、 FAT32 (vfat)、 NTFS (ntfs)和CD-ROM (iso9660)等。
4.  挂载选项（options）。文件系统可使用多种挂载选项。比如，可挂载为只读，防止在内执行程序？（可提高移动设备的安全性）。
5.  备份（dump）。使用dump命令备份时，指定是否接受备份，以及何时备份。
6.  检测/修复（pass）。使用fsck检测和修复时的执行顺序。

### 查看所有已挂载的文件系统

**使用mount命令，不带任何参数，可查看当前已挂载的所有文件系统：**

```bash
me@ubuntu16.04:~$ mount
/dev/sda1 on / type ext4 (rw,relatime,errors=remount-ro,data=ordered)
securityfs on /sys/kernel/security type securityfs (rw,nosuid,nodev,noexec,relat
ime)
tmpfs on /dev/shm type tmpfs (rw,nosuid,nodev)
tmpfs on /run/lock type tmpfs (rw,nosuid,nodev,noexec,relatime,size=5120k)
tmpfs on /sys/fs/cgroup type tmpfs (ro,nosuid,nodev,noexec,mode=755)
...
/dev/sdb1 on /media/me/disk type vfat (rw,nosuid,nodev,relatime,uid=1000,gid=1000,fmask=0022,dmask=0022,codepage=437,iocharset=iso8859-1,shortname=mixed,showexec,utf8,flush,errors=remount-ro,uhelper=udisks2)
```

输出内容的格式为：“设备名 on 挂载点 type 文件类型（挂载选项）”。比如第一行的含义为，/dev/sda1设备挂载到根目录上，文件格式为ext4，可读可写（“rw”）。

**为测试，插入一张可读写光盘后，重新执行mount命令会新增如下内容：**

```bash
me@ubuntu16.04:~$ mount | less
...
/dev/sr0 on /media/me/e-STUDIO Client type iso9660 (ro,nosuid,nodev,relatime,uid=1000,gid=1000,iocharset=utf8,mode=0400,dmode=0500,uhelper=udisks2)
...
```

上例表示，光盘设备在系统中的设备名为/dev/sr0，挂载点为/media/me/e-STUDIO Client。

**取消挂载光盘：**

```bash
me@ubuntu16.04:~$ ls /media/me #可见光盘中内容
e-STUDIO Client
me@ubuntu16.04:~$ sudo umount /dev/sr0
me@ubuntu16.04:~$ ls /media/me
# 表示光盘的文件夹消失，表示取消挂载成功
```

**为光盘新建一个挂载点，使用-t选项表示文件类型：**

```bash
me@ubuntu16.04:~$ sudo mkdir /mnt/cdrom # 新建文件夹
# 将光盘挂载到新建的文件夹上，iso9660为光盘的文件格式
me@ubuntu16.04:~$ sudo mount -t iso9660 /dev/sr0 /mnt/cdrom
me@ubuntu16.04:~$ ls /mnt/cdrom
... #出现光盘内容，表示挂载成功
me@ubuntu16.04:~$ sudo umount /dev/sr0 #再次取消挂载
me@ubuntu16.04:~$ ls /mnt/cdrom
# 无任何内容，取消挂载成功
```

### 判断挂载设备名称

在桌面系统中，设备自动挂载后可使用mount命令查看其在系统系统中的名称；但是，在不支持自动挂载的环境中（如服务器），则需要通过查看/dev文件夹来确定设备在系统中对应的名称。/dev文件夹包含了系统中所有设备（为何安卓手机设备不包含？）。

**查看所有设备：**

```bash
me@ubuntu16.04:~$ ls /dev
...
```

不同类型设备有特定的命名规则：

-   fd\*：软盘。
-   hd\*：老式系统中的IDE硬盘（IDE即Integrated Drive Electronics）。尤其是指主板有2个IED管道/接口（channels/connectors），每个接口都由一根有2个附着点的线路链接的硬盘？？。线路上的第一个硬盘称为主设备，第二个称为奴设备。命名规则为，/dev/hda表示第一个管道上的主设备，/dev/hdb表示第一个管道上的奴设备；/dev/hdc表示第二个管道上的主设备。以此类推。名称后所跟数字表示在设备上的分区号，比如/dev/hda1表示第一个硬盘上的第一个分区，/dev/hda表示整个硬盘。
-   /dev/lp\*：打印机。
-   /dev/sd_：SCSI硬盘（是采用SCSI接口的硬盘，SCSI是Small Computer System Interface”小型计算机系统接口“”的缩写，使用50针接口，外观和普通硬盘接口有些相似）。在现代Linux系统中，内核将所有disk-like设备（包括PATA/SATA硬盘、U盘、如mp3/4这样的USB大型存储设备和数码相机）都视为SCSI硬盘。命名的后半部分和/dev/hd_设备规则相同。
-   /dev/sr\*：光驱（CD/DVD读取机/刻录机）。

**在不自动挂载移动设备的环境中，可使用tail命令实时查看系统日志来判断设备名称：**

```bash
me@ubuntu16.04:~$ sudo tail -f /var/log/syslog
...
```

以插入U盘为例，当插入U盘后，会出现类似如下的类容：

```txt
...
Aug 27 21:27:42 me kernel: [14505.508766]  sdb: sdb1
Aug 27 21:27:42 me kernel: [14505.509862] sd 8:0:0:0: [sdb] Attached SCSI removable disk
...
```

通过上面结果可知，U盘对应的系统设备名称为/dev/sdb，/dev/sdb1为其第一分区。

**得知设备在系统上对应的名称后，就可将其挂载到文件树上：**

```bash
me@ubuntu16.04:~$ sudo mkdir /mnt/flash
me@ubuntu16.04:~$ sudo mount /dev/sdb1 /mnt/flash
me@ubuntu16.04:~$ df -h #使用df命令查看所有文件系统使用情况
...
/dev/sdb1        14G  548M   14G   4% /media/me/disk
# /dev/sr0        594M  594M     0 100% /media/me/e-STUDIO Client
...
```

## 创建文件系统

## 测试和修复文件系统

## 格式化软盘

## 设备间传输数据

## 创建CD-ROM镜像

## 写入CD-ROM镜像
